<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hanthink.mon.model.MonProjDelayModel">
	<select id="queryProjDealyForPage" parameterType="com.hanthink.mon.model.MonProjDelayModel" resultType="com.hanthink.mon.model.MonProjDelayModel">
		SELECT '验收' opeType,
	       MPR.RET_EMPTY_PLATFORM projName,
	       CASE
	         WHEN MSO.RECEIVE_DATE IS NULL AND MSP.PLAN_ARR_TIME IS NOT NULL THEN
	          CEIL((SYSDATE - MSP.PLAN_ARR_TIME) * 24 * 60)
	         WHEN MSO.RECEIVE_DATE IS NOT NULL AND MSP.PLAN_ARR_TIME IS NOT NULL THEN
	          CEIL((MSO.RECEIVE_DATE - MSP.PLAN_ARR_TIME) * 24 * 60)
	       END AS delayTime
	  FROM MM_SW_ORDER MSO
	  LEFT JOIN MM_SW_PICKUP_PLAN MSP
	    ON MSP.PURCHASE_NO = MSO.PURCHASE_NO
	   AND MSP.ORDER_NO = MSO.ORDER_NO
	   AND MSP.FACTORY_CODE = MSO.FACTORY_CODE
	  LEFT JOIN MM_MON_ALLOW_DEVIATION MMAD
	    ON MSP.ROUTE_CODE = MMAD.ROUTE_CODE
	  LEFT JOIN (SELECT DISTINCT A.ROUTE_CODE, A.RET_EMPTY_PLATFORM, A.WARE_CODE
	               FROM MM_PUP_ROUTE A
	              WHERE A.FACTORY_CODE = #{factoryCode}) MPR
	    ON MPR.ROUTE_CODE = MSP.ROUTE_CODE
	  LEFT JOIN (SELECT DISTINCT MI.WARE_CODE, MI.WORK_CENTER
	               FROM MM_INV_UNLOAD MI
	              WHERE MI.FACTORY_CODE = #{factoryCode}) MIU
	    ON MIU.WARE_CODE = MPR.WARE_CODE
	 WHERE MSO.RECEIVE_STATUS IN (0, 1)
	   AND MIU.WORK_CENTER = #{workCenter}
	   AND TRUNC(MSP.PLAN_ARR_TIME) = TRUNC(SYSDATE)
	   AND (MSO.RECEIVE_DATE IS NULL AND
	       MSP.PLAN_ARR_TIME + NVL(MMAD.ERROR_DATE, 30) / 60 / 24 &lt; SYSDATE OR
	       (MSO.RECEIVE_DATE IS NOT NULL AND
	       MSP.PLAN_ARR_TIME + NVL(MMAD.ERROR_DATE, 30) / 60 / 24 &lt;
	       MSO.RECEIVE_DATE))
	UNION ALL
	SELECT '验收' opeType, MMKD.DISTRI_PERSON projName, NULL delayTime
	  FROM MM_JIT_ORDER MJO
	  LEFT JOIN (SELECT A.ORDER_NO,
	                    PKG_PUB.USF_GET_BATCHSEQ_BY_PRODSEQNO(A.PLAN_CODE,
	                                                          A.ARRIVE_PRODUCT_SEQNO) PLAN_ARR_BATCHSEQNO,
	                    PKG_PUB.USF_GET_BATCHSEQ_BY_PRODSEQNO(A.PLAN_CODE,
	                                                          A.ACTUAL_ARR_PRODUCT_SEQNO) ACTUAL_ARR_BATCHSEQNO
	               FROM MM_JIT_ORDER A) TMP
	    ON TMP.ORDER_NO = MJO.ORDER_NO
	  LEFT JOIN MM_PUB_PLAN_CODE MPPC
	    ON MJO.PLAN_CODE = MPPC.PLAN_CODE
	   AND MPPC.FACTORY_CODE = #{factoryCode}
	  LEFT JOIN MM_MON_KB MMK
	    ON MPPC.KB_ID = MMK.ID
	  LEFT JOIN MM_KB_IP_CONFIG MMKD
	    ON MMKD.KB_ID = MMK.ID
	 WHERE MJO.ARRIVE_STATUS IN (0, 1)
	   AND MPPC.WORKCENTER = #{workCenter}
	   AND TRUNC(MJO.ARRIVE_TIME) = TRUNC(SYSDATE)
	   AND (TMP.ACTUAL_ARR_BATCHSEQNO IS NULL AND
	       TMP.PLAN_ARR_BATCHSEQNO &lt; MMK.CURR_BATCH_NO OR
	       (TMP.ACTUAL_ARR_BATCHSEQNO IS NOT NULL AND
	       TMP.PLAN_ARR_BATCHSEQNO &lt; TMP.ACTUAL_ARR_BATCHSEQNO))
	UNION ALL
	SELECT '验收' opeType, MMKD.DISTRI_PERSON projName, NULL delayTime
	  FROM MM_JISO_ORDER MJO
	  LEFT JOIN (SELECT A.ORDER_NO,
	                    PKG_PUB.USF_GET_BATCHSEQ_BY_PRODSEQNO(A.PLAN_CODE,
	                                                          A.ARRIVE_PRODUCT_SEQNO) ARRIVE_PRODUCT_SEQNO,
	                    PKG_PUB.USF_GET_BATCHSEQ_BY_PRODSEQNO(A.PLAN_CODE,
	                                                          A.ARRIVE_PRODUCT_SEQNO) ACTUAL_ARRIVE_PRODUCT_SEQNO
	               FROM MM_JISO_ORDER A) TMP
	    ON MJO.ORDER_NO = TMP.ORDER_NO
	  LEFT JOIN MM_PUB_PLAN_CODE MPPC
	    ON MPPC.PLAN_CODE = MJO.PLAN_CODE
	   AND MPPC.FACTORY_CODE = #{factoryCode}
	  LEFT JOIN MM_MON_KB MMK
	    ON MPPC.KB_ID = MMK.ID
	  LEFT JOIN MM_KB_IP_CONFIG MMKD
	    ON MMKD.KB_ID = MMK.ID
	 WHERE MJO.ARRIVE_STATUS IN (0, 1)
	   AND MPPC.WORKCENTER = #{workCenter}
	   AND (TMP.ARRIVE_PRODUCT_SEQNO IS NULL AND
	       TMP.ACTUAL_ARRIVE_PRODUCT_SEQNO IS NULL OR
	       (TMP.ARRIVE_PRODUCT_SEQNO IS NOT NULL AND
	       TMP.ARRIVE_PRODUCT_SEQNO &lt; TMP.ACTUAL_ARRIVE_PRODUCT_SEQNO))
	UNION ALL
	SELECT 'PC备货' opeType,
	       MJI.PREPARE_PERSON || '#' || MJI.DISTRI_PERSON projName,
	       CEIL((SYSDATE - MJI.PREPARE_TIME) * 24 * 60) delayTime
	  FROM MM_JIT_INS MJI
	  LEFT JOIN MM_PUB_PLAN_CODE MPPC
	    ON MPPC.PLAN_CODE = MJI.PLAN_CODE
	 WHERE MJI.IS_JUMP = 0
	   AND TRUNC(MJI.PREPARE_TIME) = TRUNC(SYSDATE)
	   AND MPPC.WORKCENTER = #{workCenter}
	UNION ALL
	SELECT '配送' opeType,
	       RES.DISTRI_PERSON projName,
	       CEIL((NVL(RES.GET_RUN_TIME, SYSDATE) -
	            (RES.REQUEST_RUN_TIME + RES.LIMIT_DELAY / 60 / 24)) * 24 * 60) delayTime
	  FROM (SELECT MMD.ID,
	               MMD.LIMIT_DELAY    LIMIT_DELAY,
	               MMD.CREATION_TIME  REQUEST_RUN_TIME,
	               MMD.GET_RUN_TIME   GET_RUN_TIME,
	               MMKD.DISTRI_PERSON DISTRI_PERSON,
	               MMK.WORKCENTER     WORKCENTER
	          FROM MM_MON_DISTRIBUTION_LOG MMD
	          LEFT JOIN MM_KB_IP_CONFIG MMKD
	            ON MMKD.ID = MMD.KB_DETAIL_ID
	          LEFT JOIN MM_MON_KB MMK
	            ON MMK.ID = MMKD.KB_ID
	         WHERE MMD.STATUS IN (0, 1)
	           AND (MMD.CREATION_TIME + MMD.LIMIT_DELAY / 60 / 24) &lt;
	               NVL(MMD.GET_RUN_TIME, SYSDATE)
	         ORDER BY MMD.KB_DETAIL_ID, MMD.DISTRI_PRODUCT_SEQNO) RES
	 WHERE RES.WORKCENTER = #{workCenter}
	 AND TRUNC(RES.REQUEST_RUN_TIME) = TRUNC(SYSDATE)
	UNION ALL
	SELECT '空箱返还' opeType,
	       MPD.RET_EMPTY_PLATFORM projName,
	       CEIL((NVL(MPD.LAST_MODIFIED_TIME, SYSDATE) - MPD.PLAN_START_TIME) * 24 * 60) delayTime
	  FROM MM_PUP_DCS_PICK_PLAN MPD
	  LEFT JOIN (SELECT DISTINCT MP.ROUTE_CODE, MP.WARE_CODE
	               FROM MM_PUP_ROUTE MP
	              WHERE MP.FACTORY_CODE = #{factoryCode}) MPP
	    ON MPP.ROUTE_CODE = MPD.ROUTE_CODE
	  LEFT JOIN (SELECT DISTINCT MI.WORK_CENTER, MI.WARE_CODE
	               FROM MM_INV_UNLOAD MI
	              WHERE MI.FACTORY_CODE = #{factoryCode}) MII
	    ON MII.WARE_CODE = MPP.WARE_CODE
	 WHERE MPD.PLAN_ARRIVE_TIME +
	       (SELECT MPS.PARAM_VAL
	          FROM MM_PUB_SYS_PARAM MPS
	         WHERE MPS.PARAM_CODE = 'KB_WORK_TIME'
	           AND MPS.PARAM_GROUP = 'KB_WORK_TIME') / 60 / 24 +
	       (SELECT MPS.PARAM_VAL
	          FROM MM_PUB_SYS_PARAM MPS
	         WHERE MPS.PARAM_CODE = 'KB_WAIT_TIME'
	           AND MPS.PARAM_GROUP = 'KB_WAIT_TIME') / 60 / 24 &lt;
	       NVL(MPD.LAST_MODIFIED_TIME, SYSDATE)
	   AND MII.WORK_CENTER = #{workCenter}
	   AND TRUNC(MPD.PLAN_ARRIVE_TIME) = TRUNC(SYSDATE)
	</select>
</mapper>